services:
  db-migrator:
    container_name: receipt-db-migrator
    build:
      context: ./db
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-receipt_user}:${POSTGRES_PASSWORD:-receipt_password}@postgres:5432/${POSTGRES_DB:-receipt_manager}
      MIGRATIONS_DIR: /usr/src/app/migrations
    restart: no
    networks:
      - receipt_network
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:15-alpine
    container_name: receipt-postgres
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-receipt_manager}
      - POSTGRES_USER=${POSTGRES_USER:-receipt_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-receipt_password}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - ./volumes/postgres/data:/var/lib/postgresql/data
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - receipt_network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-receipt_user} -d ${POSTGRES_DB:-receipt_manager}']
      interval: 10s
      timeout: 10s
      retries: 5

  n8n:
    image: docker.n8n.io/n8nio/n8n:2.4.8
    container_name: receipt-n8n
    ports:
      - '${N8N_PORT:-5678}:5678'
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:${N8N_PORT:-5678}/
      - GENERIC_TIMEZONE=${TIMEZONE:-America/New_York}
      - N8N_EDITOR_BASE_URL=http://localhost:${N8N_PORT:-5678}
      - NODE_FUNCTION_ALLOW_EXTERNAL=*
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_SECURE_COOKIE=false
      - N8N_METRICS=false
      - N8N_PUBLIC_API_DISABLED=false
      - N8N_LOG_LEVEL=info
      # Re-enable executeCommand node (disabled by default in n8n 2.0+)
      - NODES_EXCLUDE=[]
      # Allow file operations in /app/uploads (restricted by default in n8n 2.0+)
      - N8N_RESTRICT_FILE_ACCESS_TO=/app/uploads
      # VLM API Configuration
      - VLM_API_URL=${VLM_API_URL:-http://host.docker.internal:11434}
      - OLLAMA_VLM_MODEL=${OLLAMA_VLM_MODEL}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - PROCESSING_CRON_INTERVAL=${PROCESSING_CRON_INTERVAL:-30}
    volumes:
      - ./volumes/n8n/data:/home/node/.n8n
      - ./volumes/n8n/workflows:/home/node/.n8n/workflows
      - ./volumes/uploads:/app/uploads
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - receipt_network
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:5678/healthz || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      db-migrator:
        condition: service_completed_successfully

  web:
    image: nginx:alpine
    container_name: receipt-web
    ports:
      - '${WEB_PORT:-8080}:80'
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./volumes/uploads:/var/www/uploads:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    networks:
      - receipt_network
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider http://localhost:80/ || exit 1']
      interval: 30s
      timeout: 5s
      retries: 3
    depends_on:
      - n8n

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: receipt-pgadmin
    ports:
      - '${PGADMIN_PORT:-5050}:80'
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@local.dev}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
      # PostgreSQL credentials for auto-configuration
      - POSTGRES_DB=${POSTGRES_DB:-receipt_manager}
      - POSTGRES_USER=${POSTGRES_USER:-receipt_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-receipt_password}
    volumes:
      - ./volumes/pgadmin/data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./pgadmin/entrypoint.sh:/pgadmin-entrypoint.sh:ro
    entrypoint: /bin/sh /pgadmin-entrypoint.sh
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    networks:
      - receipt_network
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

networks:
  receipt_network:
    driver: bridge
